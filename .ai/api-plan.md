# REST API Plan

## 1. Resources

- **Accounts**
  - _Database Tables_: `auth.users`, `app.profiles`
  - Supabase Auth owns lifecycle (registration, login, password reset). `app.profiles.user_id` mirrors `auth.users.id` and stores preferences: `display_name`, `time_zone`, `marketing_opt_in`, timestamps. Triggers: `app.set_updated_at()` on `app.profiles`.

- **Flashcards**
  - _Database Table_: `app.flashcards`
  - Columns: `id`, `user_id`, `front`, `back`, `source` (`manual`, `ai-full`, `ai-edited`), `origin_generation_id`, timestamps. Constraints: `(user_id, front)` unique, text length limits (≤200/≤500), BEFORE INSERT trigger `app.flashcards_before_insert_limit` enforcing 15-card quota, `app.set_updated_at()` trigger.

- **Generations**
  - _Database Table_: `app.ai_generation_logs`
  - Tracks asynchronous AI runs: `status` (`pending`, `success`, `failed`), `source_text`, `source_text_length`, `source_text_hash`, metrics (`generated_count`, `accepted_*`, `rejected_count`, `duration_ms`), model parameters (`model`, `temperature`), proposal payload (`proposed_flashcards`), timestamps. Triggers: `app.set_updated_at()`.

- **Generation Error Logs**
  - _Database Table_: `app.ai_generation_error_logs`
  - Records failures tied to user and optional generation. Fields include `source_text_hash`, `source_text_length`, `error_code`, `error_message`, timestamps. BEFORE INSERT trigger `app.ai_generation_error_logs_before_insert_hash_validate` validates length/hash integrity.

- **Study Sessions**
  - _Virtual Resource_: generated by repetition engine fed from `app.flashcards`. Session state may be cached in-memory/temporary store; future persistence can live in dedicated table.

- **AI Metrics**
  - _Virtual Resource_: Aggregations over `app.ai_generation_logs` (per day, per model, etc.) used for KPI dashboards.

## 2. Endpoints

> **Base path**: `/api` (omitted in snippets below for brevity).

### 2.1. Profile & Account

- **GET `/me`**
  - **Description**: Return Supabase-authenticated account profile.
  - **Response 200**:
    ```json
    {
      "profile": {
        "userId": "uuid",
        "email": "user@example.com",
        "displayName": "string",
        "timeZone": "Europe/Warsaw",
        "marketingOptIn": false,
        "createdAt": "2025-01-01T12:00:00Z",
        "updatedAt": "2025-01-01T12:05:00Z"
      }
    }
    ```
  - **Errors**: 401 unauthorized session, 403 disabled account, 500 internal error.

- **PATCH `/me`**
  - **Description**: Update `displayName`, `timeZone`, `marketingOptIn`.
  - **Request**:
    ```json
    {
      "displayName": "string",
      "timeZone": "Europe/Warsaw",
      "marketingOptIn": true
    }
    ```
  - **Success 200**: Returns updated profile; optimistic concurrency handled via RLS row lock.
  - **Errors**: 400 invalid data, 401 unauthorized, 409 concurrent update, 422 validation, 500 internal error.

- **DELETE `/me`**
  - **Description**: Permanently delete account (Supabase Auth + cascading app data).
  - **Request**:
    ```json
    {
      "confirmation": "delete-my-account"
    }
    ```
  - **Success 204**: No body.
  - **Errors**: 400 missing confirmation, 401 unauthorized, 409 already scheduled, 500 internal error.

### 2.2. Flashcards

- **GET `/flashcards`**
  - **Description**: Paginated list of authenticated user flashcards.
  - **Query**: `page` (default 1), `pageSize` (default 20, max 50), `sort` (`createdAt:desc` default), filters `source`, `search` (front/back full-text).
  - **Response 200**:
    ```json
    {
      "data": [
        {
          "id": "uuid",
          "front": "Question",
          "back": "Answer",
          "source": "ai-full",
          "originGenerationId": "uuid",
          "createdAt": "2025-01-01T12:20:00Z",
          "updatedAt": "2025-01-01T12:20:00Z"
        }
      ],
      "pagination": {
        "page": 1,
        "pageSize": 20,
        "totalItems": 10,
        "totalPages": 1
      }
    }
    ```
  - **Errors**: 400 invalid pagination, 401 unauthorized, 500 internal error.

- **GET `/flashcards/{id}`**
  - **Description**: Fetch single flashcard owned by user.
  - **Response 200**: Flashcard object.
  - **Errors**: 401 unauthorized, 404 not found, 500 internal error.

- **POST `/flashcards`**
  - **Description**: Create manual flashcard (one at a time for UI simplicity).
  - **Request**:
    ```json
    {
      "front": "Question",
      "back": "Answer",
      "source": "manual"
    }
    ```
  - **Response 201**: Created flashcard with timestamps; `source` defaults to `manual`.
  - **Validation**: `front` ≤200 chars (trimmed), `back` ≤500 chars, `(user_id, front)` unique, reject when user already has 15 cards.
  - **Errors**: 400 missing fields, 401 unauthorized, 409 duplicate/limit reached, 422 length violation, 500 internal error.

- **PATCH `/flashcards/{id}`**
  - **Description**: Update `front`, `back`, optionally `source` (`ai-edited` when user tweaks AI output).
  - **Request**:
    ```json
    {
      "front": "Edited Question",
      "back": "Edited Answer",
      "source": "ai-edited"
    }
    ```
  - **Response 200**: Updated flashcard.
  - **Errors**: 400 no changes, 401 unauthorized, 404 not found, 409 duplicate front, 422 validation, 500 internal error.

- **DELETE `/flashcards/{id}`**
  - **Description**: Remove flashcard and free quota slot.
  - **Success 204**: No content.
  - **Errors**: 401 unauthorized, 404 not found, 500 internal error.

### 2.3. Generations

- **POST `/ai-generations`**
  - **Description**: Submit source text for AI flashcard proposals.
  - **Request**:
    ```json
    {
      "sourceText": "string between 1000 and 10000 characters",
      "model": "openrouter/model-name",
      "temperature": 0.8,
      "maxFlashcards": 15
    }
    ```
  - **Response 202**:
    ```json
    {
      "generation": {
        "id": "uuid",
        "status": "pending",
        "sourceTextLength": 2500,
        "maxFlashcards": 15,
        "createdAt": "2025-01-01T12:35:00Z",
        "expiresAt": "2025-01-01T12:40:00Z"
      }
    }
    ```
  - **Business Rules**: Reject parallel pending job; compute `source_text_hash`; enqueue worker; log metrics.
  - **Errors**: 400 text outside bounds, 401 unauthorized, 409 already pending, 413 payload too large, 422 invalid model parameters, 500 internal error.

- **GET `/ai-generations`**
  - **Description**: List generation history for user.
  - **Query**: `page`, `pageSize`, `status`, `from`, `to`.
  - **Response 200**: Array with metrics (`generatedCount`, `acceptedCount`, etc.)
  - **Errors**: 400 invalid filters, 401 unauthorized, 500 internal error.

- **GET `/ai-generations/{id}`**
  - **Description**: Retrieve proposals & status for specific generation.
  - **Response 200**: Includes `proposedFlashcards` (each z `proposalId`, `front`, `back`, opcjonalnym `source` i `metadata`), `maxFlashcards`, `metrics` oraz `sourceTextHash`.
  - **Errors**: 401 unauthorized, 404 not owned/not found, 409 still pending (optional polling guard), 500 internal error.

- **POST `/ai-generations/{id}/commit`**
  - **Description**: Accept/edit/reject proposals; persists approved cards referencing generation.
  - **Request**:
    ```json
    {
      "flashcards": [
        {
          "proposalId": "uuid",
          "action": "accept",
          "front": "string",
          "back": "string"
        },
        {
          "proposalId": "uuid",
          "action": "reject"
        }
      ]
    }
    ```
  - **Response 200**: Summary of accepted/rejected/skipped plus created flashcards.
  - **Business Rules**: Enforce 15-card limit, classify `source` (`ai-full` when untouched, `ai-edited` when modified), update counters (`accepted_*`, `rejected_count`), set `status` to `success` or `failed` (if nothing accepted and errors occurred).
  - **Errors**: 400 invalid payload, 401 unauthorized, 404 generation/proposal not found, 409 quota exceeded or already committed, 422 validation, 500 internal error.

- **POST `/ai-generations/{id}/retry`**
  - **Description**: Retry failed generation with optional new model params.
  - **Request**:
    ```json
    {
      "model": "openrouter/alternate",
      "temperature": 0.7
    }
    ```
  - **Response 202**: Returns pending retry referencing previous generation.
  - **Errors**: 400 not retryable, 401 unauthorized, 404 not found, 409 retry already queued, 422 invalid params, 500 internal error.

- **DELETE `/ai-generations/{id}`**
  - **Description**: Cancel pending generation.
  - **Success 204**: No content.
  - **Errors**: 400 already completed, 401 unauthorized, 404 not found, 500 internal error.

### 2.4. Generation Error Logs (Service Role)

- **GET `/admin/ai-generation-errors`**
  - **Description**: Inspect error history for diagnostics (service-role only).
  - **Query**: `page`, `pageSize` (default 50, max 100), `userId`, `model`, `errorCode`, `from`, `to`.
  - **Response 200**: Paginated list of error log entries.
  - **Errors**: 401 missing service key, 403 forbidden role, 500 internal error.

### 2.5. Study Sessions

- **POST `/study-sessions`**
  - **Description**: Start spaced repetition session capped by `maxCards` and `includeSources` filters.
  - **Request**:
    ```json
    {
      "maxCards": 15,
      "includeSources": ["manual", "ai-full", "ai-edited"]
    }
    ```
  - **Response 201**: Session identifier and initial queue.
  - **Business Rules**: Ensure no concurrent active session; select due cards via repetition algorithm.
  - **Errors**: 400 invalid payload, 401 unauthorized, 409 active session exists, 500 internal error.

- **GET `/study-sessions/{id}`**
  - **Description**: Retrieve current session state (next card, progress counts).
  - **Response 200**: Session snapshot; hides card back until revealed.
  - **Errors**: 401 unauthorized, 404 session not found/expired, 410 completed, 500 internal error.

- **POST `/study-sessions/{id}/reviews`**
  - **Description**: Submit review outcome driving scheduling (ratings `again`, `hard`, `good`, `easy`).
  - **Request**:
    ```json
    {
      "flashcardId": "uuid",
      "rating": "good",
      "revealed": true
    }
    ```
  - **Response 200**: Last review summary and next card preview.
  - **Errors**: 400 invalid rating/card mismatch, 401 unauthorized, 404 session/card missing, 409 session desync, 500 internal error.

### 2.6. AI Metrics (Service Role)

- **GET `/admin/ai-metrics`**
  - **Description**: Aggregate KPIs for monitoring AI adoption and quality.
  - **Query**: `from` (required ISO timestamp), `to` (required), `groupBy` (`day`, `model`, etc.).
  - **Response 200**:
    ```json
    {
      "window": {
        "from": "2025-01-01T00:00:00Z",
        "to": "2025-01-07T23:59:59Z"
      },
      "metrics": {
        "acceptanceRate": 0.8,
        "aiUsageRate": 0.75,
        "averageDurationMs": 3200,
        "totalGenerations": 50,
        "totalAccepted": 200,
        "totalRejected": 40
      },
      "breakdown": [
        {
          "key": "2025-01-01",
          "acceptanceRate": 0.78,
          "aiUsageRate": 0.73,
          "averageDurationMs": 3100,
          "totalGenerations": 7
        }
      ]
    }
    ```
  - **Errors**: 400 invalid dates, 401 missing service key, 403 forbidden role, 500 internal error.

## 3. Authentication & Authorization

- Supabase Auth issues JWTs (bearer header or session cookies). Middleware validates token and enriches Astro `locals` with user context.
- Row Level Security:
  - `app.profiles`: policies `profiles_select_own`, `profiles_update_own`, `profiles_insert_self` allow self-access only.
  - `app.flashcards`: `flashcards_manage_own` permits CRUD for owner.
  - `app.ai_generation_logs`: `ai_generation_logs_manage_own` permits select/insert/update; delete reserved for service role via `ai_generation_logs_delete_service_role`.
  - `app.ai_generation_error_logs`: self-select/insert policy plus service-role delete.
- Admin routes (`/admin/*`) require service-role key checked in middleware; responses omit unnecessary PII.
- Rate limiting: token bucket (~60 req/min per user) via Astro middleware; elevated limits for service-role routes.
- Enforce HTTPS, short-lived Supabase tokens, and audit logging for destructive actions (account deletion, admin access).

## 4. Validation & Business Logic

- **Profiles**: Validate `displayName` length ≤120, `timeZone` against IANA database, `marketingOptIn` boolean. Reject updates when Supabase email not confirmed if required by product.
- **Flashcards**: Trim text; enforce character limits; `source` defaults to `manual`. BEFORE INSERT trigger guards 15-card quota. Patching `source` -> `ai-edited` when user modifies AI proposal. Ensure `origin_generation_id` references existing generation (when provided).
- **Generations**: Guard text length (1000–10000), compute/store length and hash (`pgcrypto`). Maintain invariant `accepted_unedited_count + accepted_edited_count = accepted_count` and `generated_count ≥ accepted_count + rejected_count`. `app.log_ai_generation()` helper updates metrics once commit completes. Pending generations auto-expire via job timeout (future enhancement).
- **Generation Error Logs**: Insertions validate `source_text_length` and compute hash server-side for automated entries. Client-side write limited to service-role contexts.
- **Study Sessions**: Guard no active session per user, filter cards by due state (Spaced Repetition algorithm). Ratings update scheduling fields (integration with external library).
- **Error Handling**: Standard error envelope `{ "error": { "code": "VALIDATION_ERROR", "message": "...", "details": [...] } }` for 4xx responses. Avoid leaking stack traces.
- **Observability**: Capture `model`, `temperature`, duration, and counts for each generation; log admin actions; instrument success/error metrics for API routes.

## 5. Data Integrity, Indexes & Performance

- Enable `pgcrypto` extension and create `app` schema before tables.
- Indexes:
  - `app.flashcards`: `user_id`, `origin_generation_id`, `source`.
  - `app.ai_generation_logs`: composite `(user_id, created_at DESC)`, `status`, `source_text_hash`.
  - `app.ai_generation_error_logs`: `(user_id, created_at DESC)`.
- All mutable tables use `app.set_updated_at()` trigger to keep timestamps consistent.
- Use early validation/preflight checks to short-circuit expensive operations (LLM calls, DB writes).
- Background jobs perform AI requests; API remains responsive (202 Accepted pattern).

## 6. Security & Compliance Notes

- Enforce RODO requirements: implement `/me` deletion cascade, retain audit trail for admin reads without storing excess PII.
- Sensitive logs: redact `source_text` in production logs, store only hashes for duplicate detection.
- Rate-limit AI endpoints separately to control cost exposure; consider per-user quota for AI generations.
- Ensure study session responses expose card backs only after client signals reveal to protect content in transit.
